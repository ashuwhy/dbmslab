# Backend Changelog & Implementation Report

**Date:** 2026-02-10
**Status:** Ready for Deployment / Push
**Module:** Instructor Module & Backend Core

---

## 1. Summary of Changes
This update enhances the backend with robust instructor features, fixes critical database schema issues, implements advanced DBMS concepts (window functions, triggers, locking), and provides a bulletproof seeding script.

---

## 2. Code Modifications

### 2.1 Configuration & Dependencies
- **`requirements.txt`**: Added `python-dotenv` and `bcrypt`.
- **`database.py`**: Fixed `.env` file loading path to ensure environment variables are read correctly from the project root.

### 2.2 Schema Updates (handled by Seed Script)
- **`student` table**: Added `email` column (Unique).
- **`course` table**: Added `max_capacity` and `current_enrollment` columns.
- **`instructor` table**: Added `user_id` foreign key linking to `app_user`.
- **`audit_log` table**: Created for tracking grade changes (active database feature).
- **`content_item` table**: Created for managing course materials.

### 2.3 API Router (`routers/instructor.py`)
- **Fixed Analytics Query**: Replaced incompatible `filter()` calls with `SUM(CASE WHEN ...)` to ensure PostgreSQL compatibility.
- **Added Advanced Endpoints**:
    1.  `GET /courses/{id}/rankings`: Uses **Window Functions** (`RANK`, `DENSE_RANK`, `PERCENT_RANK`) to rank students.
    2.  `GET /courses/{id}/audit-log`: Queries the database audit trail generated by triggers.
    3.  `POST /courses/{id}/safe-enroll`: Implements **Pessimistic Locking** (`SELECT ... FOR UPDATE`) to prevent race conditions during enrollment.

---

## 3. Database Features Implemented (Advanced DBMS)

### 3.1 Triggers (Active Database)
- **`trg_audit_grade_change`**: Automatically inserts a record into `audit_log` whenever a student's `evaluation_score` is updated.
- **`trg_auto_enrollment_count`**: Automatically increments/decrements `course.current_enrollment` when a student enrolls or unenrolls.

### 3.2 Concurrency Control
- **Safe Enrollment**: Used `SELECT ... FOR UPDATE` to lock course rows during enrollment, ensuring the `max_capacity` check is atomic and thread-safe.

### 3.3 Indexing
- **Performance Indexes**: Added indexes on `instructor.user_id`, `student.country`, and `enrollment.evaluation_score`.

---

## 4. Seeding & Dummy Data (`scripts/seed_data.py`)

A robust **Version 3** seed script was created that handles fresh or reset database states.

### 4.1 Seeded Instructors
| Name | Email | Password |
|---|---|---|
| Andrew Ng | `andrew.ng@stanford.edu` | `instructor123` |
| Yann LeCun | `yann.lecun@mit.edu` | `instructor123` |
| Yoshua Bengio | `yoshua.bengio@oxford.edu` | `instructor123` |
| Fei-Fei Li | `fei-fei@stanford.edu` | `instructor123` |
| Ian Goodfellow | `ian.goodfellow@mit.edu` | `instructor123` |

### 4.2 Seeded Relationships
- **Teaching Assignments**: 10 assignments created (Andrew Ng teaches 5 courses).
- **Content Items**: 17 items (Videos, Notes, Books) link to courses.
- **Students**: 15 students created with valid emails and enrollments.

---

## 5. Verification status
A comprehensive test script (`scripts/test_instructor.py`) validates correctness.

| Endpoint | Status | Notes |
|---|---|---|
| `POST /auth/login` | ✅ PASS | Returns JWT token |
| `GET /instructor/courses` | ✅ PASS | Returns assigned courses |
| `GET /courses/{id}/students` | ✅ PASS | Lists enrolled students |
| `GET /courses/{id}/analytics` | ✅ PASS | Correctly computes distribution |
| `PUT /enrollments/{sid}/{cid}` | ✅ PASS | Updates grade & trigger fires |
| `GET /courses/{id}/rankings` | ✅ PASS | Window functions working |
| `GET /courses/{id}/audit-log` | ✅ PASS | Audit records retrieved |
| `POST /courses/{id}/safe-enroll`| ✅ PASS | Locking mechanism works |

---

## 6. Files Created
1. `apps/api/scripts/seed_data.py`: Main seeding logic.
2. `apps/api/scripts/test_instructor.py`: End-to-end verification.
3. `apps/api/scripts/check_db.py`: Quick DB diagnostic tool.
4. `apps/api/reports/CHANGELOG_REPORT.md`: This file.
